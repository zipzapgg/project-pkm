{% extends "base.html" %}
{% block title %}Hasil Analisis{% endblock %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<div class="card shadow-lg mx-auto p-4 p-md-5 fade-in-scale mb-5" style="max-width: 1140px; border-radius: 24px;">
  
  <div class="text-center mb-5">
    <div class="mb-3">
      <span style="font-size: 4rem; display: inline-block; animation: celebrate 1s ease;">üéâ</span>
    </div>
    <h3 class="fw-bold mb-2" style="color: #2d3748;">Hasil Analisis Potensi Akademik</h3>
    <p class="text-muted">Halo <span class="text-primary fw-bold">{{ nama }}</span>, berikut adalah rekomendasi jurusan yang paling sesuai untukmu.</p>
  </div>

  <div class="row g-5">
      <div class="col-lg-5">
          <div class="card border-0 shadow-sm p-4 bg-light rounded-4 h-100">
              <div class="text-center mb-4">
                  <div class="bg-white p-3 rounded-circle shadow-sm d-inline-block mb-3">
                      <span class="fs-2">üß≠</span>
                  </div>
                  <h5 class="fw-bold text-dark">Peta Minat Kamu</h5>
                  <p class="small text-muted mb-0">Visualisasi keseimbangan antara Logika, Sosial, Kreatif, dan Bahasa.</p>
              </div>
              
              <div class="chart-container flex-grow-1 d-flex align-items-center" style="position: relative; height:300px; width:100%;">
                  <canvas id="minatChart"></canvas>
              </div>
          </div>
      </div>

      <div class="col-lg-7">
        <div class="d-flex align-items-center mb-4 ps-2 border-start border-4 border-primary">
            <h5 class="fw-bold mb-0">üèÜ Top 3 Rekomendasi</h5>
            <span class="badge bg-primary ms-2 bg-opacity-10 text-primary border border-primary border-opacity-25">Confidence: {{ confidence }}</span>
        </div>

        <div class="d-flex flex-column gap-3">
          {% for jurusan, nilai in hasil %}
          
          <div class="card border-0 p-4 hover-card transition-all" style="background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03);">
            <div class="d-flex align-items-start gap-3">
                
                <div class="flex-shrink-0 d-flex align-items-center justify-content-center text-white fw-bold shadow-sm" 
                     style="width: 40px; height: 40px; border-radius: 12px; 
                     background: {% if loop.index == 1 %}linear-gradient(135deg, #FFD700, #FFA500){% elif loop.index == 2 %}linear-gradient(135deg, #A0A0A0, #808080){% else %}linear-gradient(135deg, #CD7F32, #8B4513){% endif %};">
                    #{{ loop.index }}
                </div>

                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h5 class="fw-bold text-dark mb-0">{{ jurusan }}</h5>
                        
                        <span class="badge rounded-pill px-3" 
                              style="background-color: {% if loop.index == 1 %}#2ecc71{% elif loop.index == 2 %}#3498db{% else %}#f1c40f{% endif %};">
                            {{ "%.1f"|format(nilai) }}%
                        </span>
                    </div>

                    <p class="text-muted small mb-3" style="line-height: 1.5;">
                        {% if "Informatika" in jurusan or "Komputer" in jurusan or "Sains Data" in jurusan or "Sistem Informasi" in jurusan %}
                            <i class="bi bi-cpu"></i> Bidang Teknologi & Komputer. Fokus pada logika, coding, dan analisis sistem.
                        {% elif "Kedokteran" in jurusan or "Farmasi" in jurusan or "Kesehatan" in jurusan or "Gizi" in jurusan %}
                            <i class="bi bi-heart-pulse"></i> Bidang Kesehatan. Membutuhkan ketelitian tinggi dan pemahaman sains yang kuat.
                        {% elif "Ekonomi" in jurusan or "Akuntansi" in jurusan or "Manajemen" in jurusan or "Bisnis" in jurusan %}
                            <i class="bi bi-graph-up"></i> Bidang Ekonomi & Bisnis. Fokus pada pengelolaan sumber daya dan keuangan.
                        {% elif "Sastra" in jurusan or "Komunikasi" in jurusan or "Hubungan Internasional" in jurusan or "Pariwisata" in jurusan or "Humas" in jurusan %}
                            <i class="bi bi-chat-quote"></i> Bidang Sosial & Bahasa. Mengutamakan kemampuan komunikasi dan analisis verbal.
                        {% elif "Teknik" in jurusan or "Arsitektur" in jurusan or "Mesin" in jurusan or "Elektro" in jurusan or "Agroteknologi" in jurusan %}
                            <i class="bi bi-building"></i> Bidang Teknik & Rancang Bangun. Logika matematika dan sains sangat dominan.
                        {% else %}
                            <i class="bi bi-mortarboard"></i> Jurusan yang sesuai dengan profil kompetensi akademik dan minat kamu.
                        {% endif %}
                    </p>
                    
                    <div class="progress" style="height: 8px; border-radius: 10px; background-color: #f0f0f0;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ nilai }}%; 
                                    background: {% if loop.index == 1 %}#0061ff{% elif loop.index == 2 %}#6c757d{% else %}#d35400{% endif %};" 
                             aria-valuenow="{{ nilai }}" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
  </div>

  <hr class="my-5 opacity-10">

  <div class="text-center">
      <button class="btn btn-sm btn-light text-muted border rounded-pill px-4 mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#debugInfo">
          üõ†Ô∏è Lihat Detail Perhitungan (Debug Mode)
      </button>
  </div>
  <div class="collapse" id="debugInfo">
      <div class="card card-body bg-light border-0 small text-start rounded-4 p-4">
          <h6 class="fw-bold">Logika Profile Matching:</h6>
          <div class="table-responsive">
              <table class="table table-bordered table-sm bg-white rounded-3 overflow-hidden">
                  <thead class="table-light">
                      <tr>
                          <th>Jurusan</th>
                          <th>Gap (U/D/M)</th>
                          <th>Bobot</th>
                          <th>Skor Akhir</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for log in details.detail_perhitungan %}
                      <tr>
                          <td>{{ log.jurusan }}</td>
                          <td>{{ log['gaps']['u'] }} / {{ log['gaps']['d'] }} / {{ log['gaps']['m'] }}</td>
                          <td>{{ log['bobots']['u'] }} / {{ log['bobots']['d'] }} / {{ log['bobots']['m'] }}</td>
                          <td class="fw-bold">{{ log.final_score }}</td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
          </div>
      </div>
  </div>

  <div class="text-center mt-4 d-flex gap-3 justify-content-center flex-wrap">
    <a href="/tes" class="btn btn-outline-primary px-4 py-3 rounded-pill fw-bold">
      üîÑ Tes Ulang
    </a>
    <button onclick="window.print()" class="btn btn-outline-secondary px-4 py-3 rounded-pill fw-bold">
      üñ®Ô∏è Simpan PDF
    </button>
    <a href="/" class="btn btn-primary px-5 py-3 rounded-pill fw-bold shadow">
      üè† Kembali ke Beranda
    </a>
  </div>
</div>

<style>
  @keyframes celebrate {
    0%, 100% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.2) rotate(-10deg); }
    75% { transform: scale(1.2) rotate(10deg); }
  }
  
  .hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
  }
  
  @media print {
    .btn, .collapse, .navbar, footer { display: none !important; }
    .card { box-shadow: none !important; border: 1px solid #ddd !important; }
    body { background: white !important; }
  }
</style>

<script>
  const minatData = {{ minat | tojson }};
  const ctx = document.getElementById('minatChart').getContext('2d');
  
  new Chart(ctx, {
      type: 'radar',
      data: {
          labels: ['Logika', 'Sosial', 'Kreatif', 'Bahasa'],
          datasets: [{
              label: 'Profil Minat',
              data: [minatData.logika, minatData.sosial, minatData.kreatif, minatData.bahasa],
              fill: true,
              backgroundColor: 'rgba(0, 97, 255, 0.2)',
              borderColor: '#0061ff',
              pointBackgroundColor: '#0061ff',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#0061ff'
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
              r: {
                  angleLines: { color: '#e2e8f0' },
                  grid: { color: '#e2e8f0' },
                  suggestedMin: 0,
                  suggestedMax: 5,
                  ticks: { stepSize: 1, backdropColor: 'transparent', display: false }
              }
          },
          plugins: { legend: { display: false } }
      }
  });

  window.onload = function() {
      var duration = 3 * 1000;
      var animationEnd = Date.now() + duration;
      var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
      function randomInRange(min, max) { return Math.random() * (max - min) + min; }
      var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) { return clearInterval(interval); }
        var particleCount = 50 * (timeLeft / duration);
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
      }, 250);
  };
</script>

{% endblock %}